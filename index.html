<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <h3>è‡ªå‹•æ‰“å¡ä¸­...</h3>
  <script>
    // Haversine function to calculate distance between two lat/lon points
    function haversineDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3; // metres
        const Ï†1 = lat1 * Math.PI / 180; // Ï†, Î» in radians
        const Ï†2 = lat2 * Math.PI / 180;
        const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
        const Î”Î» = (lon2 - lon1) * Math.PI / 180;

        const a = Math.sin(Î”Ï† / 2) * Math.sin(Î”Ï† / 2) +
                  Math.cos(Ï†1) * Math.cos(Ï†2) *
                  Math.sin(Î”Î» / 2) * Math.sin(Î”Î» / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

        const d = R * c; // in metres
        return d;
    }

    const checkinCenterLat = 22.582212;
    const checkinCenterLon = 120.404301;
    const maxDistance = 200; // meters

    liff.init({ liffId: "ä½ çš„_LIFF_ID" })
      .then(() => liff.getCurrentPosition())
      .then(pos => {
        const { latitude, longitude } = pos.coords;
        const distance = haversineDistance(
          latitude,
          longitude,
          checkinCenterLat,
          checkinCenterLon
        );

        let messageText;
        if (distance <= maxDistance) {
          messageText = `âœ… æ‰“å¡æˆåŠŸï¼\nğŸ“ ä½ç½®ï¼š${latitude}, ${longitude}\nè·é›¢ä¸­å¿ƒï¼š${distance.toFixed(2)} å…¬å°º`;
        } else {
          messageText = `âŒ æ‰“å¡å¤±æ•—ï¼\nğŸ“ ä½ç½®ï¼š${latitude}, ${longitude}\nè·é›¢ä¸­å¿ƒï¼š${distance.toFixed(2)} å…¬å°º (è¶…å‡º ${maxDistance} å…¬å°ºç¯„åœ)`;
        }

        return liff.sendMessages([
          { type: "text", text: messageText }
        ]);
      })
      .then(() => liff.closeWindow())
      .catch(err => {
        alert("å®šä½å¤±æ•—æˆ–ç™¼ç”ŸéŒ¯èª¤ï¼š" + err);
        liff.closeWindow(); // Ensure window closes even on error
      });
  </script>
</body>
</html>
