<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <h3>è‡ªå‹•æ‰“å¡ä¸­...</h3>
    <script>
      function haversineDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3;
        const Ï†1 = lat1 * Math.PI / 180;
        const Ï†2 = lat2 * Math.PI / 180;
        const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
        const Î”Î» = (lon2 - lon1) * Math.PI / 180;

        const a = Math.sin(Î”Ï† / 2) ** 2 +
                  Math.cos(Ï†1) * Math.cos(Ï†2) *
                  Math.sin(Î”Î» / 2) ** 2;
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
      }

      const checkinCenterLat = 22.582212;
      const checkinCenterLon = 120.404301;
      const maxDistance = 200; // meters

      async function main() {
        await liff.init({ liffId: "2008432102-M9Wgn3WG" });
        if (!liff.isInClient()) {
          alert("è«‹åœ¨ LINE App å…§é–‹å•Ÿæ­¤é€£çµ");
          return;
        }

        navigator.geolocation.getCurrentPosition(async pos => {
          const { latitude, longitude } = pos.coords;
          const distance = haversineDistance(latitude, longitude, checkinCenterLat, checkinCenterLon);

          let messageText;
          if (distance <= maxDistance) {
            messageText = `âœ… æ‰“å¡æˆåŠŸï¼\nğŸ“ ä½ç½®ï¼š${latitude}, ${longitude}\nè·é›¢ä¸­å¿ƒï¼š${distance.toFixed(2)} å…¬å°º`;
          } else {
            messageText = `âŒ æ‰“å¡å¤±æ•—ï¼\nğŸ“ ä½ç½®ï¼š${latitude}, ${longitude}\nè·é›¢ä¸­å¿ƒï¼š${distance.toFixed(2)} å…¬å°º (è¶…å‡º ${maxDistance} å…¬å°ºç¯„åœ)`;
          }

          await liff.sendMessages([{ type: "text", text: messageText }]);
          liff.closeWindow();
        }, err => {
          alert("å®šä½å¤±æ•—ï¼š" + err.message+ " / " + err.message);
          console.log(err);
          liff.closeWindow();
        });
      }

      main().catch(err => alert("LIFF åˆå§‹åŒ–éŒ¯èª¤ï¼š" + err));
    </script>
</body>
</html>
